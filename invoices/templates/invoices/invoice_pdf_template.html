<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-G">
    <title>Invoice {{ invoice.invoice_number }}</title>
    <style>
        body { font-family: sans-serif; margin: 20px; color: #333; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { margin: 0; color: #4a4a4a; }
        .invoice-details, .customer-details, .company-details { margin-bottom: 20px; line-height: 1.6; }
        .invoice-details table, .line-items-table { width: 100%; border-collapse: collapse; }
        .invoice-details th, .invoice-details td, .line-items-table th, .line-items-table td {
            border: 1px solid #ddd; padding: 8px; text-align: left;
        }
        .line-items-table th { background-color: #f2f2f2; }
        .text-right { text-align: right; }
        .totals { margin-top: 30px; width: 50%; margin-left: auto; }
        .totals td { border: none; }
        .footer { margin-top: 40px; text-align: center; font-size: 0.9em; color: #777; }
        .company-logo { max-width: 150px; max-height: 70px; float: right; } /* Example */
        .clearfix::after { content: ""; clear: both; display: table; }
    </style>
</head>
<body>
    <div class="header clearfix">
        <h1>Invoice</h1>
    </div>

    <div class="company-details">
        <strong>Your Company Name</strong><br>
        Your Company Address<br>
        Your City, State, Pin<br>
        Your Company GSTIN: YOUR_GSTIN_HERE <br>
        Email: your@email.com | Phone: YOUR_PHONE
    </div>

    <table class="invoice-details">
        <tr>
            <th style="width:50%;">Billed To:</th>
            <th style="width:50%;">Invoice Details:</th>
        </tr>
        <tr>
            <td>
                <strong>{{ invoice.customer.name|default:"N/A" }}</strong><br>
                {% if invoice.gst_treatment == "BUSINESS_GST" and invoice.gst_no %}
                    GSTIN: {{ invoice.gst_no }}<br>
                {% endif %}
                Place of Supply: {{ invoice.get_place_of_supply_display }}
                {# Add more customer address details if available from customer object #}
            </td>
            <td>
                <strong>Invoice Number:</strong> {{ invoice.invoice_number }}<br>
                <strong>Date:</strong> {{ invoice.date|date:"d M Y" }}<br>
                <strong>Due Date:</strong> {{ invoice.due_date|date:"d M Y" }}<br>
                {% if invoice.reference_number %}
                    <strong>Reference:</strong> {{ invoice.reference_number }}<br>
                {% endif %}
                <!-- {% if invoice.payment_terms_label %}
                    <strong>Payment Terms:</strong> {{ invoice.payment_terms_label }}<br>
                {% endif %} -->
            </td>
        </tr>
    </table>

    <h3>Items</h3>
    <table class="line-items-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Item & Description</th>
                <th class="text-right">Qty</th>
                <th class="text-right">Rate ({{ invoice.currency }})</th>
                <th class="text-right">Tax %</th>
                <th class="text-right">Amount ({{ invoice.currency }})</th>
            </tr>
        </thead>
        <tbody>
            {% for item in line_items_display %}  {# Ensure you are using line_items_display from context #}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                    <strong>{{ item.name }}</strong><br>
                    <small>{{ item.description|default:"" }}</small>
                    {% if item.hsn_or_sac %}<br><small>HSN/SAC: {{ item.hsn_or_sac }}</small>{% endif %}
                </td>
                <td class="text-right">{{ item.quantity|floatformat:2 }}</td>         {# Corrected #}
                <td class="text-right">{{ item.rate|floatformat:2 }}</td>             {# Corrected #}
                <td class="text-right">{{ item.tax_percentage|floatformat:2 }}%</td>   {# Corrected #}
                <td class="text-right">{{ item.item_display_total|floatformat:2 }}</td> {# Corrected - uses pre-calculated total #}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <table class="totals">
        <tr>
            <td>Subtotal:</td>
            <td class="text-right">{{ invoice.sub_total|floatformat:2 }} {{ invoice.currency }}</td> {# Corrected #}
        </tr>
        {% if invoice.discount_amount > 0 %}
        <tr>
            <td>Discount:</td>
            <td class="text-right">- {{ invoice.discount_amount|floatformat:2 }} {{ invoice.currency }}</td> {# Corrected #}
        </tr>
        {% endif %}
        <tr>
            <td>Total Tax:</td>
            <td class="text-right">{{ invoice.total_tax_amount|floatformat:2 }} {{ invoice.currency }}</td> {# Corrected #}
        </tr>
         {% if invoice.other_charges > 0 %}
        <tr>
            <td>Other Charges:</td>
            <td class="text-right">{{ invoice.other_charges|floatformat:2 }} {{ invoice.currency }}</td> {# Corrected #}
        </tr>
        {% endif %}
        <tr>
            <td><strong>Grand Total:</strong></td>
            <td class="text-right"><strong>{{ invoice.grand_total|floatformat:2 }} {{ invoice.currency }}</strong></td> {# Corrected #}
        </tr>
    </table>

    {% if invoice.notes %}
    <div class="notes" style="margin-top: 20px;">
        <strong>Notes:</strong><br>
        <p>{{ invoice.notes|linebreaksbr }}</p>
    </div>
    {% endif %}

    {% if invoice.terms %}
    <div class="terms" style="margin-top: 20px;">
        <strong>Terms & Conditions:</strong><br>
        <p>{{ invoice.terms|linebreaksbr }}</p>
    </div>
    {% endif %}

    <div class="footer">
        This is a computer-generated invoice.
    </div>
</body>
</html>